{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<h3 class="mb-3">Dashboard</h3>

{% if no_data %}
  <div class="alert alert-info">Belum ada dataset. Silakan upload CSV.</div>
{% else %}

<!-- Pilih Dataset -->
<form method="GET" class="mb-3">
  <label class="form-label">Pilih Dataset</label>
  <select name="file_id" class="form-select" onchange="this.form.submit()">
    {% for f in user_files %}
    <option value="{{ f.id }}" {% if f.id == selected_file_id %}selected{% endif %}>
      {{ f.filename }} ({{ f.upload_time.strftime('%Y-%m-%d %H:%M') }})
    </option>
    {% endfor %}
  </select>
</form>

<!-- Kartu Statistik -->
<div class="row mb-4">
  <div class="col-md-3"><div class="card"><div class="card-body">
    <h6>Total Rows</h6><h3>{{ total_rows }}</h3>
  </div></div></div>

  <div class="col-md-3"><div class="card"><div class="card-body">
    <h6>Total Columns</h6><h3>{{ total_cols }}</h3>
  </div></div></div>

  <div class="col-md-3"><div class="card"><div class="card-body">
    <h6>Total Missing</h6><h3>{{ missing_total }}</h3>
  </div></div></div>

  <div class="col-md-3"><div class="card"><div class="card-body">
    <h6>Outlier Count</h6><h3>{{ outlier_count }}</h3>
  </div></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Histogram Options -->
{% if chart_data.hist_choices %}
<form method="GET" class="row mb-3">

    <input type="hidden" name="file_id" value="{{ selected_file_id }}">

    <div class="col-md-6">
        <label class="form-label">Pilih Fitur Histogram</label>
        <select name="hist_col" class="form-select" onchange="this.form.submit()">
            {% for c in chart_data.hist_choices %}
            <option value="{{ c }}" {% if c == chart_data.hist_col %}selected{% endif %}>
                {{ c }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-6">
        <label class="form-label">Mode</label>
        <select name="hist_mode" class="form-select" onchange="this.form.submit()">
            <option value="raw" {% if chart_data.hist_mode == "raw" %}selected{% endif %}>Raw</option>
            <option value="scaled" {% if chart_data.hist_mode == "scaled" %}selected{% endif %}>Scaled</option>
        </select>
    </div>

</form>
{% endif %}


<div class="row">
  {% if chart_data.hist_values %}
  <div class="col-md-6 mb-4">
    <h5>Histogram ({{ chart_data.hist_column }})</h5>
    <canvas id="histChart"></canvas>
  </div>
  {% endif %}

  <div class="col-md-6 mb-4">
    <h5>Outlier vs Normal</h5>
    <canvas id="outlierChart"></canvas>
  </div>
</div>

{% if chart_data.cat_labels %}
<div class="row mb-4">
  <div class="col-md-12">
    <h5>Distribusi Kategori ({{ chart_data.cat_column }})</h5>
    <canvas id="catChart"></canvas>
  </div>
</div>
{% endif %}

{% if chart_data.corr_labels %}
<form method="GET" class="mb-3">
    <input type="hidden" name="file_id" value="{{ selected_file_id }}">

    <label class="form-label">Pilih Fitur Korelasi</label>
    <select name="corr_target" class="form-select" onchange="this.form.submit()">
        {% for c in chart_data.corr_choices %}
        <option value="{{ c }}" {% if c == chart_data.corr_target %}selected{% endif %}>
            {{ c }}
        </option>
        {% endfor %}
    </select>
</form>
{% endif %}


{% if chart_data.corr_labels %}
<div class="row mb-4">
  <div class="col-md-12">
    <h5>Korelasi terhadap: <b>{{ chart_data.corr_target }}</b></h5>
    <canvas id="corrBarChart"></canvas>
  </div>
</div>
{% endif %}


<script>
const chartData = {{ chart_data | tojson }};

// 1. HISTOGRAM (BINNING)
  
if (chartData.hist_values && chartData.hist_values.length > 0) {

    const values = chartData.hist_values;

    // Automatic bin count (Freedmanâ€“Diaconis rule)
    const sorted = [...values].sort((a, b) => a - b);
    const q1 = sorted[Math.floor(sorted.length * 0.25)];
    const q3 = sorted[Math.floor(sorted.length * 0.75)];
    const iqr = q3 - q1;

    const binWidth = (2 * iqr) / Math.cbrt(values.length) || 1;
    const bins = Math.max(5, Math.min(40, Math.floor((sorted[sorted.length - 1] - sorted[0]) / binWidth)));

    const min = sorted[0];
    const max = sorted[sorted.length - 1];
    const step = (max - min) / bins;

    let histogram = new Array(bins).fill(0);

    values.forEach(v => {
        let idx = Math.floor((v - min) / step);
        if (idx < 0) idx = 0;
        if (idx >= bins) idx = bins - 1;
        histogram[idx]++;
    });

    let labels = [];
    for (let i = 0; i < bins; i++) {
        labels.push((min + i * step).toFixed(2));
    }

    new Chart(document.getElementById("histChart"), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: chartData.hist_col + " (" + chartData.hist_mode + ")",
                data: histogram,
                backgroundColor: 'rgba(54,162,235,0.65)',
                borderColor: 'rgba(54,162,235,1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    title: { display: true, text: "Frequency" }
                }
            }
        }
    });
}

// 2. OUTLIER BAR CHART
new Chart(document.getElementById('outlierChart'), {
    type: 'bar',
    data: {
      labels: ['Normal', 'Outlier'],
      datasets: [{
        label: 'Count',
        data: [
          chartData.outlier_counts.Normal,
          chartData.outlier_counts.Outlier
        ],
        backgroundColor: ['#4CAF50', '#E53935']
      }]
    }
});

// 3. BAR CHART KATEGORI
if (chartData.cat_labels) {
    new Chart(document.getElementById("catChart"), {
        type: "bar",
        data: {
            labels: chartData.cat_labels,
            datasets: [{
                label: chartData.cat_column,
                data: chartData.cat_counts,
                backgroundColor: 'rgba(255,159,64,0.7)'
            }]
        },
        options: {
            indexAxis: 'x'
        }
    });
}



// 4. CORRELATION BAR CHART
// CORRELATION BAR CHART WITH DROPDOWN
if (chartData.corr_labels) {
    new Chart(document.getElementById("corrBarChart"), {
        type: "bar",
        data: {
            labels: chartData.corr_labels,
            datasets: [{
                label: "Correlation with " + chartData.corr_target,
                data: chartData.corr_values,
                backgroundColor: chartData.corr_values.map(v =>
                    v >= 0 ? "rgba(54,162,235,0.7)" : "rgba(255,99,132,0.7)"
                )
            }]
        },
        options: {
            scales: {
                y: {
                    min: -1,
                    max: 1,
                    title: { display: true, text: "Correlation Coefficient" }
                }
            }
        }
    });
}

</script>

{% endif %}
{% endblock %}
